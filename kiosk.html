<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenTasks Kiosk Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }
        body::before {
            content: '';
            position: fixed;
            top: -1px; left: -1px;
            width: 1px; height: 1px;
            background: rgba(255,255,255,0.001);
            animation: preventSleep 30s infinite;
        }
        @keyframes preventSleep { 0%,100%{opacity:0.001;}50%{opacity:0.002;} }

        .container { position: relative; width:100vw; height:100vh; }
        .logo {
            position: absolute; z-index: 10;
            width: 150px; height: auto;
            pointer-events: none;
        }
        .main-content { width:100%; height:100%; }

        .profile-selection {
            position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
            gap:1rem; width:80%; max-width:800px;
        }
        .profile-card {
            background: #1f2937; border-radius:16px;
            padding:2rem; text-align:center;
            cursor:pointer; transition:transform .3s;
            display:flex; flex-direction:column; justify-content:center;
            min-height:150px;
        }
        .profile-card:hover { transform:scale(1.05); }
        .profile-avatar { font-size:4rem; margin-bottom:.5rem; }
        .profile-name { font-size:1.5rem; font-weight:600; }

        .pin-modal {
            position:fixed; inset:0;
            background:rgba(0,0,0,0.9);
            display:none; flex-direction:column;
            align-items:center; justify-content:center;
            z-index:20;
        }
        .pin-modal.active { display:flex; }
        .pin-display {
            font-size:2rem; letter-spacing:1rem;
            margin-bottom:1.5rem;
        }
        .pin-buttons {
            display:grid; grid-template-columns:repeat(3,100px);
            gap:1rem; margin-bottom:1.5rem;
        }
        .pin-button {
            width:100px; height:100px;
            background:#374151; border-radius:12px;
            font-size:2rem; display:flex;
            align-items:center; justify-content:center;
            cursor:pointer; user-select:none;
        }
        .pin-ok {
            width:100px; height:60px;
            background:#10b981; border-radius:12px;
            font-size:1.5rem; display:flex;
            align-items:center; justify-content:center;
            cursor:pointer;
        }
        .pin-error {
            color:#ef4444;
            margin-top:1rem; height:1.2rem;
            font-size:1rem;
        }

        .task-list {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            width:90%; max-width:900px;
            display:none; flex-direction:column; gap:1.5rem;
        }
        .task-list.active { display:flex; }
        .back-button {
            align-self:flex-start;
            background:#374151; border-radius:12px;
            padding:.75rem 1.5rem; cursor:pointer;
            font-weight:600;
        }
        .task-header { text-align:center; margin-bottom:1rem; }
        .task-header h2 { font-size:2.5rem; }
        .task-header p { font-size:1rem; color:#9ca3af; }

        .tasks-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:1rem;
        }
        .task-button {
            background:#374151; border-radius:16px;
            padding:1.5rem; text-align:center;
            cursor:pointer; position:relative;
            display:flex; flex-direction:column;
            justify-content:center; min-height:120px;
        }
        .task-title { font-size:1.25rem; font-weight:600; }
        .task-meta { font-size:.85rem; color:#9ca3af; margin-top:.5rem; }
        .task-button.completed {
            background:#059669;
            animation:completePulse .6s ease-out;
        }
        .task-button.completed::after {
            content:'✓'; font-size:2.5rem; color:#fff;
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
        }
        @keyframes completePulse { 0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);} }

        .idle-toast {
            position:fixed; bottom:2rem; left:50%; transform:translateX(-50%);
            width:80%; max-width:400px; height:10px;
            background:rgba(17,24,39,0.5);
            border-radius:8px; overflow:hidden;
            display:none; z-index:15;
        }
        .idle-toast.visible { display:block; }
        .progress-bar {
            height:100%;
            background:linear-gradient(to right,#10b981,#34d399);
            animation:progressBar 3s linear forwards;
        }
        @keyframes progressBar { from{width:100%;}to{width:0;} }

        .fullscreen-button {
            position:fixed; top:1rem; right:1rem;
            background:rgba(79,70,229,0.8); border:none;
            border-radius:8px; padding:.5rem;
            cursor:pointer; font-size:1.2rem; z-index:15;
        }
    </style>
</head>
<body>
    <button class="fullscreen-button" onclick="toggleFullscreen()">⛶</button>
    <div class="container">
        <img id="logo" class="logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA" alt="ZenTasks Logo" />
        <main class="main-content">
            <div class="profile-selection" id="profileSelection"></div>
            <div class="pin-modal" id="pinModal">
                <div class="pin-display" id="pinDisplay"></div>
                <div class="pin-buttons" id="pinButtons"></div>
                <div class="pin-ok" id="pinOk">OK</div>
                <div class="pin-error" id="pinError"></div>
            </div>
            <div class="task-list" id="taskList">
                <div class="back-button" id="backButton" onclick="showProfileSelection()">← Back</div>
                <div class="task-header">
                    <h2 id="taskHeaderTitle">Tasks</h2>
                    <p id="taskHeaderSubtitle"></p>
                </div>
                <div class="tasks-grid" id="tasksGrid"></div>
            </div>
        </main>
    </div>
    <div class="idle-toast" id="idleToast"><div class="progress-bar"></div></div>
    <script>
        const API_BASE = window.location.hostname==='localhost'?'http://localhost:3001/api':'/api';
        const IDLE_TIMEOUT = 3000;
        const PIN_IDLE_TIMEOUT = 3000;
        let userData = {profiles:[],tasks:[]};
        let currentUser = null;
        let idleTimer, pinIdleTimer;
        let pinInput = '';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            showProfileSelection();
            setupIdle();
            setupPin();
            startBounce(document.getElementById('profileSelection'), 1.5);
            startBounce(document.getElementById('logo'), 1);
            requestWakeLock();
            setTimeout(toggleFullscreen, 1000);
        });

        async function loadUserData() {
            try { const res = await fetch(`${API_BASE}/data/1`); userData = await res.json(); }
            catch { userData = {profiles:[],tasks:[]}; }
        }

        function showProfileSelection() {
            clearIdle(); hidePinModal();
            currentUser = null;
            document.getElementById('taskList').classList.remove('active');
            const ps = document.getElementById('profileSelection'); ps.innerHTML = '';
            userData.profiles.forEach(p => {
                const card = document.createElement('div'); card.className = 'profile-card';
                card.innerHTML = `<div class="profile-avatar">${p.avatar}</div><div class="profile-name">${p.name}</div>`;
                card.onclick = () => selectProfile(p);
                ps.appendChild(card);
            });
        }

        function selectProfile(profile) {
            currentUser = profile;
            if (profile.pin) showPinModal(); else showTaskList();
        }

        function setupPin() {
            const container = document.getElementById('pinButtons'); container.innerHTML = '';
            for (let i = 1; i <= 9; i++) createPinButton(i);
            createPinButton(0);
            document.getElementById('pinOk').onclick = checkPin;
        }

        function createPinButton(num) {
            const btn = document.createElement('div'); btn.className = 'pin-button'; btn.textContent = num;
            btn.onclick = () => {
                pinInput += num;
                document.getElementById('pinDisplay').textContent = '*'.repeat(pinInput.length);
                resetPinIdle();
            };
            document.getElementById('pinButtons').appendChild(btn);
        }

        function showPinModal() {
            pinInput = '';
            document.getElementById('pinDisplay').textContent = '';
            document.getElementById('pinError').textContent = '';
            document.getElementById('pinModal').classList.add('active');
            resetPinIdle();
        }

        function hidePinModal() {
            document.getElementById('pinModal').classList.remove('active');
            clearTimeout(pinIdleTimer);
        }

        function resetPinIdle() {
            clearTimeout(pinIdleTimer);
            pinIdleTimer = setTimeout(() => {
                hidePinModal();
                showProfileSelection();
            }, PIN_IDLE_TIMEOUT);
        }

        function checkPin() {
            clearTimeout(pinIdleTimer);
            if (pinInput === String(currentUser.pin)) {
                hidePinModal();
                showTaskList();
            } else {
                document.getElementById('pinError').textContent = 'Invalid PIN';
                pinInput = '';
                document.getElementById('pinDisplay').textContent = '';
                setTimeout(() => { document.getElementById('pinError').textContent = ''; }, 1500);
                resetPinIdle();
            }
        }

        function showTaskList() {
            clearIdle();
            document.getElementById('profileSelection').style.display = 'none';
            const tl = document.getElementById('taskList'); tl.classList.add('active');
            document.getElementById('taskHeaderTitle').textContent = `${currentUser.name}'s Tasks`;
            const now = new Date(), dow = now.getDay();
            const tasks = userData.tasks.filter(t => t.profiles.includes(currentUser.id) && isInTimeframe(t, dow));

            const grid = document.getElementById('tasksGrid'); grid.innerHTML = '';
            tasks.forEach(t => {
                const btn = document.createElement('div'); btn.className = 'task-button' + (t.isCompleted ? ' completed' : '');
                btn.innerHTML = `<div class="task-title">${t.title}</div><div class="task-meta">${t.groupName||'Other'} | ${t.recurrence}</div>`;
                if (!t.isCompleted) btn.onclick = () => completeTask(t, btn);
                grid.appendChild(btn);
            });

            document.getElementById('taskHeaderSubtitle').textContent = `${tasks.filter(x => x.isCompleted).length} of ${tasks.length} done`;
        }

        function isInTimeframe(task, day) {
            if (task.recurrence === 'daily') return true;
            if (task.recurrence === 'weekly' && task.dayOfWeek === day) return true;
            return false;
        }

        async function completeTask(task, btn) {
            btn.classList.add('completed');
            await fetch(`${API_BASE}/data/1`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(userData)
            });
            const userTasks = userData.tasks.filter(t => t.profiles.includes(currentUser.id));
            if (userTasks.every(t => t.isCompleted)) celebrate();
            showTaskList();
        }

        function setupIdle() {
            ['click','mousemove','keypress','touchstart'].forEach(e => document.addEventListener(e, resetIdle, true));
            resetIdle();
        }

        function resetIdle() {
            clearTimeout(idleTimer);
            document.getElementById('idleToast').classList.remove('visible');
            idleTimer = setTimeout(() => {
                document.getElementById('idleToast').classList.add('visible');
                setTimeout(showProfileSelection, IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);
        }

        function clearIdle() {
            clearTimeout(idleTimer);
            document.getElementById('idleToast').classList.remove('visible');
        }

        function celebrate() {
            const c = document.createElement('div');
            c.textContent = '🎉 All done!';
            c.style.cssText = 'position:fixed;inset:0;display:flex;justify-content:center;align-items:center;font-size:4rem;';
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 2000);
        }

        function startBounce(el, speed) {
            let dx = speed, dy = speed;
            el.style.position = 'absolute';
            const move = () => {
                const r = el.getBoundingClientRect();
                if (r.left < 0 || r.right > window.innerWidth) dx = -dx;
                if (r.top < 0 || r.bottom > window.innerHeight) dy = -dy;
                el.style.left = (r.left + dx) + 'px';
                el.style.top = (r.top + dy) + 'px';
                requestAnimationFrame(move);
            };
            el.style.left = Math.random() * (window.innerWidth - el.offsetWidth) + 'px';
            el.style.top = Math.random() * (window.innerHeight - el.offsetHeight) + 'px';
            requestAnimationFrame(move);
        }

        function requestWakeLock() {
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(() => {});
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
